# Техническая Документация: Модуль prompt_constructor.py

## 1. Краткое Резюме

`prompt_constructor.py` — это служебный модуль, реализующий стратегически важную функцию иерархического построения системных промптов. Его основная задача — программно конструировать финальный промпт для AI-агента, объединяя инструкции из различных источников (клиент, сервер, ядро агента) в единую, структурированную и предсказуемую директиву. Модуль решает проблему конфликтующих инструкций путем установления явной иерархии приоритетов и информирования LLM об этой иерархии.

## 2. Архитектурная Роль и Решаемая Проблема

По мере усложнения AI-систем, поведение агента определяется несколькими слоями конфигурации: глобальными правилами на стороне сервера (политики безопасности), динамическими инструкциями от клиента ("личность" агента) и основной логикой мышления (ReAct-паттерн). Простое объединение этих инструкций может сбить модель с толку, привести к непредсказуемым результатам или позволить клиентским инструкциям "переопределить" критически важные правила безопасности.

`prompt_constructor.py` решает эту проблему, внедряя детерминированный алгоритм сборки промпта, который:
*   Устанавливает четкий порядок приоритета инструкций.
*   Структурирует промпт с помощью явных Markdown-разделителей, улучшая его читаемость для LLM.
*   Включает "мета-инструкцию", которая напрямую указывает модели, как разрешать конфликты между различными блоками.

## 3. Ключевая Функция и Алгоритм Работы

Модуль предоставляет одну основную функцию, которая интегрирована в `react_driver.py` для подготовки каждого запроса к AI-агенту.

```python
def build_final_prompt(
    react_pattern_prompt: str,
    client_system_instruction: Optional[str] = None,
    client_manifests: Optional[List[str]] = None,
    server_system_instruction: Optional[str] = None,
    server_manifests: Optional[List[str]] = None,
) -> str:
    ...
```

**Алгоритм сборки промпта:**
1.  **Мета-инструкция:** Промпт всегда начинается с неизменной "мета-инструкции", объясняющей модели правила игры:
    > "You are an AI agent. Follow the instructions below in the strict order they appear. If any instruction in a later section contradicts an instruction from a previous section, the instruction from the previous section has absolute priority."
2.  **Иерархическая сборка блоков:** Функция последовательно добавляет блоки инструкций. Благодаря мета-инструкции, порядок добавления определяет приоритет (более ранние блоки важнее).
    *   **Блок 1: CLIENT INSTRUCTIONS (Наивысший приоритет)**
        *   **Содержимое:** Объединяет `client_system_instruction` и содержимое файлов из `client_manifests`.
        *   **Назначение:** Позволяет конечному пользователю кастомизировать поведение агента, задавать его "личность", роль или специфические для задачи инструкции. Этот блок имеет абсолютный приоритет над всеми остальными.
    *   **Блок 2: CORE REASONING FRAMEWORK (Средний приоритет)**
        *   **Содержимое:** `react_pattern_prompt`.
        *   **Назначение:** Содержит основную логику мышления агента (например, ReAct), определяющую, как использовать инструменты, как рассуждать и в каком формате давать ответ.
    *   **Блок 3: GLOBAL SERVER INSTRUCTIONS (Самый низкий приоритет)**
        *   **Содержимое:** Объединяет `server_system_instruction` и содержимое файлов из `server_manifests`.
        *   **Назначение:** Содержит глобальные, неизменные правила, установленные на стороне сервера. Это "последняя линия обороны" для внедрения политик безопасности, этических ограничений, определения "тона голоса" по умолчанию и других фундаментальных правил.

## 4. Пример Структуры Финального Промпта

```
You are an AI agent. Follow the instructions below in the strict order they appear. If any instruction in a later section contradicts an instruction from a previous section, the instruction from the previous section has absolute priority.

### CLIENT INSTRUCTIONS (HIGHEST PRIORITY)

[Содержимое client_system_instruction и client_manifests]

### CORE REASONING FRAMEWORK

[Содержимое react_pattern_prompt с описанием ReAct-цикла]

### GLOBAL SERVER INSTRUCTIONS (LOWEST PRIORITY)

[Содержимое server_system_instruction и server_manifests с правилами безопасности]
```

## 5. Архитектурная Ценность и Бизнес-Эффект

Интеграция `prompt_constructor.py` в основной рабочий процесс позволила превратить AI-агента из гибкого прототипа в зрелый, надежный и безопасный AI-продукт.
*   **Повышение Безопасности и Надежности (Guardrails):** Модуль позволяет внедрять неизменные серверные инструкции (этические ограничения, политики безопасности) в качестве "последней линии обороны", которые присутствуют в каждом запросе и не могут быть переопределены клиентом.
*   **Улучшение Управляемости (Controllability):** Явное указание приоритетов в промпте значительно повысило предсказуемость поведения модели, что критически важно для production-систем, где требуется стабильное качество ответов.
*   **Создание Уникальной "Личности" Сервиса (Branding):** Модуль позволяет задавать базовые "оттенки" и "тон голоса" на уровне серверных инструкций, формируя уникальный стиль общения AI-агента, сохраняя при этом возможность кастомизации со стороны клиента.
*   **Платформа для Продвинутого Промпт-Инжиниринга:** Конструктор является основой для реализации сложных техник структурирования промптов, позволяя гибко управлять расположением и форматом каждого элемента для достижения оптимальной производительности с различными LLM.