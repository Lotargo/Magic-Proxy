# Техническая Документация: Модуль run.py

## 1. Краткое Резюме

`run.py` — это универсальный скрипт-оркестратор для локальной разработки с поддержкой "горячей перезагрузки" (hot-reload). Его задача — запустить все сервисы, составляющие приложение "Universal AI Gateway", как независимые подпроцессы, агрегировать их логи в единый поток и автоматически перезапускать их при обнаружении изменений в исходном коде. Это обеспечивает максимально быструю и комфортную итеративную разработку.

## 2. Архитектурная Роль и Решаемая Проблема

Современное микросервисное приложение состоит из нескольких компонентов, которые должны работать одновременно. В процессе разработки постоянная ручная перезагрузка каждого сервиса после внесения малейшего изменения в код — это медленный, утомительный и подверженный ошибкам процесс.

`run.py` решает эту проблему, создавая легковесную среду "все-в-одном", которая:
*   **Упрощает запуск:** Запускает всю систему одной командой (`python run.py`).
*   **Централизует логирование:** Собирает логи от всех сервисов в одной консоли.
*   **Реализует "Горячую Перезагрузку":** (Ключевая особенность). Скрипт запускает `uvicorn` и `mcp_server` в режимах, которые отслеживают изменения в `.py` файлах. Как только вы сохраняете файл с изменениями, соответствующий сервис автоматически перезагружается, немедленно применяя новый код. Это кардинально ускоряет цикл "код -> тест".
*   **Обеспечивает корректное завершение:** Гарантирует, что все процессы будут корректно остановлены по сигналу Ctrl+C.

**Важно:** `run.py` не предназначен для production-окружения. Флаг `--reload` неэффективен и небезопасен для реальной эксплуатации. Его роль — быть инструментом для разработчика. Для production-развертывания следует использовать `docker-compose.yml`.

## 3. Ключевые Компоненты и Логика Работы

### 3.1. Запуск Подпроцессов (start_process)

*   **Механизм:** Вместо простого импорта и вызова функций, скрипт использует `subprocess.Popen` для запуска каждого сервиса (`main.py` через `uvicorn` и `mcp_server.py`) в отдельном, изолированном процессе операционной системы. Это максимально точно эмулирует реальную микросервисную архитектуру.
*   **Обработка кодировки:** Скрипт принудительно устанавливает переменную окружения `PYTHONIOENCODING='utf-8'` для каждого подпроцесса. Это решает распространенные проблемы с отображением Unicode-символов (например, кириллицы) в логах в ОС Windows.

### 3.2. Агрегация Логов в Реальном Времени (stream_output)

*   **Механизм:** Для каждого запущенного подпроцесса создается отдельный поток (`threading.Thread`), который в цикле читает `stdout` этого процесса построчно.
*   **Демонические потоки:** Потоки-логгеры являются демоническими (`daemon = True`), что означает, что они не будут препятствовать завершению основного скрипта.

### 3.3. Оркестрация Запуска и "Горячая Перезагрузка"

Центральным элементом является конфигурация команд для запуска подпроцессов.

```python
# Фрагмент из main() в run.py
mcp_command = [sys.executable, "-u", str(project_root / "mcp_server.py")]
main_proxy_command = [
    sys.executable, "-u",
    "-m", "uvicorn",
    "main:app",
    "--host", "0.0.0.0",
    "--port", "8001",
    "--reload"  # <--- КЛЮЧЕВОЙ ФЛАГ
]
```

**Как работает "горячая перезагрузка":**
*   **Для main-proxy:** Команда запуска явно включает флаг `--reload` для `uvicorn`. Uvicorn автоматически начинает отслеживать все `.py` файлы в текущей директории и ее поддиректориях. При сохранении любого из этих файлов, `uvicorn` грациозно перезапускает воркер с `main:app`, применяя изменения.
*   **Для mcp-server:** Хотя `mcp_server.py` запускается напрямую, `uvicorn` внутри него (в блоке `if __name__ == "__main__"`) также использует опцию `reload=True`. Таким образом, он обладает тем же поведением.
*   **Применение изменений "на лету":** Эта функция особенно полезна при работе с UI. Например, если вы меняете конфигурацию через админ-панель (которая редактирует `proxy_config.yaml`), сервер `main-proxy` этого не заметит. Но если вы внесете изменение в код, который обрабатывает эту конфигурацию, сервер мгновенно перезапустится и начнет работать с новой логикой.

## 4. Использование

Для запуска всей экосистемы приложения в режиме быстрой итеративной разработки достаточно выполнить одну команду:

```bash
python run.py
```

Теперь вы можете:
1.  Открыть любой `.py` файл проекта в вашем редакторе.
2.  Внести изменение и сохранить файл.
3.  Наблюдать, как в консоли, где запущен `run.py`, соответствующий сервис (например, `[Main Proxy]`) автоматически перезагружается, выводя сообщения о перезапуске.
4.  Сразу же тестировать новое поведение через API, без ручных действий.

Для остановки всей системы просто нажмите `Ctrl+C` в том же окне терминала.