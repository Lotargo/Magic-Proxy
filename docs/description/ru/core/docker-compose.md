# Руководство по Развертыванию и Мониторингу с Docker Compose

## 1. Обзор Архитектуры

Этот файл `docker-compose.yml` описывает и оркестрирует полноценную среду для разработки и мониторинга "MagicProxy". Он автоматически настраивает и запускает не только само приложение, но и весь необходимый стек для асинхронной работы и централизованного сбора логов.

Система состоит из следующих сервисов:
*   **app-runner**: Основной сервис приложения. Запускает скрипт `run.py`, который, в свою очередь, поднимает `magic-proxy` и `mcp-server` в одном процессе.
*   **kafka & redis**: Инфраструктурные сервисы для асинхронных задач, кэширования и real-time сообщений.
*   **Стек Наблюдаемости (Observability Stack)**:
    *   **loki**: "База данных" для ваших логов.
    *   **promtail**: Сборщик логов, который автоматически обнаруживает все запущенные контейнеры и отправляет их логи в Loki.
    *   **grafana**: Платформа для визуализации, где вы будете просматривать и анализировать логи из Loki.

## 2. Предварительные Требования (Checklist)

Перед первым запуском убедитесь, что в корневой директории вашего проекта существуют следующие файлы и папки. `docker-compose` ожидает их найти, чтобы корректно собрать и запустить систему.

*   [ ✅ ] `Dockerfile`: "Рецепт" для сборки Docker-образа вашего Python-приложения.
*   [ ✅ ] `requirements.txt`: Список Python-зависимостей, которые будут установлены в образ.
*   [ ✅ ] `keys_pool/`: Директория с файлами API-ключей для `key_manager`.
*   [ ✅ ] `env/`: Директория с файлами ключей для инструментов (`mcp_server`).
*   [ ✅ ] `proxy_config.yaml`: Основной конфигурационный файл вашего шлюза.
*   [ ✅ ] `config/`: Директория с конфигурационными файлами для стека мониторинга. Структура должна быть следующей:
    ```
    config/
    ├── loki/
    │   └── local-config.yaml
    ├── promtail/
    │   └── promtail-config.yml
    └── grafana/
        └── provisioning/
            └── datasources/
                └── loki.yml
    ```

## 3. Ключевые Архитектурные Решения в docker-compose.yml

Понимание этих нюансов критически важно для успешной эксплуатации.

### 3.1. app-runner и Централизованный Лог

Вместо того чтобы запускать `uvicorn` напрямую, сервис `app-runner` выполняет `python run.py`. Это сделано намеренно: `run.py` агрегирует логи от `magic-proxy` и `mcp-server` в единый поток вывода. Это позволяет Promtail собирать все логи приложения из одного источника, что значительно упрощает их последующий анализ в Grafana.

### 3.2. Надежный Запуск через healthcheck и depends_on

Простая директива `depends_on` гарантирует только порядок запуска контейнеров, но не их готовность. В нашем файле используется более надежный механизм:

*   **healthcheck**: В сервисах `kafka` и `redis` определены команды, которые Docker периодически выполняет внутри контейнера, чтобы проверить, что сервис не просто запущен, а полностью работоспособен.
*   **condition: service_healthy**: В сервисе `app-runner` эта инструкция говорит: "Не запускайся, пока healthcheck'и у `kafka` и `redis` не будут успешно пройдены".

Это решает критическую проблему "состояния гонки", предотвращая ошибки `Connection refused`, которые возникают, когда приложение пытается подключиться к еще не готовой базе данных или брокеру сообщений.

### 3.3. Сетевая Конфигурация Kafka

Сервис Kafka настроен с двумя "слушателями":

*   `EXTERNAL://localhost:9092`: Для подключения к Kafka с вашего хост-компьютера (например, для отладки).
*   `INTERNAL://kafka:9093`: Для подключения к Kafka из других контейнеров внутри Docker-сети.

Поэтому в `app-runner` мы используем `KAFKA_BROKER=kafka:9093`. Это обеспечивает правильное и эффективное сетевое взаимодействие внутри Docker.

## 4. Запуск и Управление Системой

Все команды должны выполняться в директории, где находится файл `docker-compose.yml`.

### 4.1. Первоначальный запуск

```bash
docker-compose up -d
```

Эта команда соберет образ, скачает зависимости и запустит все контейнеры. Запуск может занять до минуты, так как `app-runner` будет ждать полной готовности Kafka.

### 4.2. Просмотр логов в Grafana

1.  Откройте в браузере `http://localhost:3000`.
2.  Войдите в систему (логин/пароль по умолчанию: `admin/admin`).
3.  Перейдите в раздел "Explore" (иконка компаса).
4.  Источник данных `Loki` уже должен быть выбран.
5.  Используйте поле "Log browser" для запросов к логам.

**Примеры запросов:**
*   Все логи от вашего приложения: `{container_name="app-runner"}`
*   Только ошибки: `{container_name="app-runner"} |= "ERROR"`
*   Логи от Kafka: `{container_name="kafka"}`

### 4.3. Остановка системы

```bash
docker-compose down
```

### 4.4. Пересборка образа приложения

Если вы изменили `Dockerfile` или `requirements.txt`, используйте эту команду:

```bash
docker-compose up -d --build
```