# Техническая Документация: Модуль api.js

## 1. Краткое Резюме
`api.js` — это слой доступа к данным (Data Access Layer) для фронтенд-приложения. Его единственная задача — инкапсулировать всю логику сетевого взаимодействия с бэкенд-API "MagicProxy". Модуль предоставляет набор асинхронных, типизированных функций, которые абстрагируют fetch-запросы, обработку ошибок и URL-адреса, предоставляя остальному коду (например, `ui.js`) чистый и семантически понятный интерфейс для работы с данными.

## 2. Архитектурная Роль и Назначение
Использование этого модуля следует принципу разделения ответственности (Separation of Concerns). Вместо того чтобы "размазывать" `fetch`-запросы по всему коду `ui.js`, вся сетевая логика централизована в одном месте. Это дает несколько ключевых преимуществ:
*   **Поддерживаемость:** Если URL-адрес API или формат ответа изменится, изменения нужно будет внести только в одном файле.
*   **Читаемость:** Код в `ui.js` становится декларативным. Вместо `fetch(...)` он вызывает `api.fetchConfig()`, что само по себе объясняет намерение.
*   **Обработка Ошибок:** Модуль обеспечивает единообразную обработку ошибок. Каждая функция проверяет `response.ok` и в случае неудачного HTTP-статуса генерирует `Error` с информативным сообщением, что упрощает отладку.
*   **Конфигурация:** Базовый URL API (`API_BASE_URL`) определен как константа в одном месте, что упрощает переключение между средами (например, с `localhost` на `production-server`).

## 3. Справочник по Функциям API
Функции модуля логически сгруппированы по областям ответственности, соответствующим вкладкам и функциям UI.

### 3.1. Управление Конфигурацией и Админ-Панелью
Эти функции используются для инициализации и работы вкладки "Конфигурация".

#### `async function fetchConfig()`
*   **Эндпоинт:** `GET /admin/config`
*   **Назначение:** Загружает текущее содержимое файла `proxy_config.yaml` с сервера.
*   **Возвращает:** `{ content: "..." }`

#### `async function fetchProviderModels()`
*   **Эндпоинт:** `GET /admin/provider_models`
*   **Назначение:** Загружает список доступных моделей для каждого провайдера, используемый для заполнения выпадающих списков в редакторе `model_list`.
*   **Возвращает:** `{ "google": ["gemini-1.5-pro", ...], "mistral": [...] }`

#### `async function saveConfig(content, restartAfterSave)`
*   **Эндпоинт:** `POST /admin/config`
*   **Назначение:** Отправляет на сервер новое содержимое `proxy_config.yaml` для сохранения.
*   **Параметры:**
    *   `content: string`: Новое содержимое файла.
    *   `restartAfterSave: boolean`: Если `true`, после сохранения будет вызвана функция `restartServer()`.

#### `async function restartServer()`
*   **Эндпоинт:** `POST /admin/restart`
*   **Назначение:** Отправляет на сервер команду для немедленного перезапуска.

### 3.2. Управление Промптами и Манифестами
Эти функции используются для работы вкладки "Prompts".

#### `async function fetchPromptsAndManifests()`
*   **Эндпоинт:** `GET /admin/prompts`
*   **Назначение:** Загружает списки всех доступных файлов промптов и манифестов.
*   **Возвращает:** `{ "prompts": ["path/to/prompt1.txt", ...], "manifests": [...] }`

#### `async function fetchFileContent(path)`
*   **Эндпоинт:** `GET /admin/prompt_content`
*   **Назначение:** Загружает текстовое содержимое конкретного файла по его пути.
*   **Возвращает:** `{ "path": "...", "content": "..." }`

#### `async function saveFileContent(path, content)`
*   **Эндпоинт:** `POST /admin/prompt_content`
*   **Назначение:** Сохраняет новое содержимое для указанного файла.

### 3.3. Логика "Playground"
Эти функции используются для инициализации и запуска сессий во вкладке "Playground".

#### `async function fetchRunnableModels()`
*   **Эндпоинт:** `GET /v1/models/all-runnable`
*   **Назначение:** Загружает список всех `model_alias`, доступных для запуска, включая их метаданные (например, `is_agent`).
*   **Возвращает:** `[{ "id": "gemini-agent", "name": "gemini-agent", "is_agent": true, ... }, ...]`

#### `async function fetchReactPatterns()`
*   **Эндпоинт:** `GET /admin/react_patterns`
*   **Назначение:** Загружает список всех автоматически обнаруженных ReAct-паттернов.

#### `async function runSimpleChat(payload)`
*   **Эндпоинт:** `POST /v1/chat/completions`
*   **Назначение:** Инициирует простой, не-агентный чат-запрос.
*   **Возвращает:** `Response`. Важно: Эта функция не читает тело ответа, а возвращает "сырой" объект `Response`, так как `ui.js` будет самостоятельно читать из него потоковые данные (`response.body`).

#### `async function runAgent(payload)`
*   **Эндпоинт:** `POST /v1/react/sessions`
*   **Назначение:** Инициирует сложную, агентную ReAct-сессию.
*   **Возвращает:** `Response`. Аналогично `runSimpleChat`, возвращает объект `Response` для последующей потоковой обработки в `ui.js`.