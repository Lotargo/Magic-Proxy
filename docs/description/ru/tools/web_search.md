# Техническая документация: Инструмент `tools/web_search.py`

## 1. Обзор и архитектурная роль
`tools/web_search.py` — это специализированный модуль-инструмент, который предоставляет AI-агенту возможность выполнять поисковые запросы в интернете. Он инкапсулирует всю логику взаимодействия с внешним поисковым API **Tavily AI**, предоставляя единую, простую функцию `search` для использования внутри `mcp_server.py`.

Этот инструмент выполняет роль **"органа чувств"** для AI-агента, позволяя ему выходить за рамки своих внутренних знаний и получать доступ к актуальной, фактологической информации из реального мира. Это критически важно для решения задач, требующих:
*   Данных в реальном времени (новости, курсы валют, погода).
*   Верификации фактов (проверка утверждений, поиск источников).
*   Информации, выходящей за пределы знаний модели (недавние события, специфические продукты).

Модуль спроектирован для работы исключительно в связке с `mcp_server.py`, который выступает для него в роли защищенного шлюза.

## 2. Реализация

### 2.1. Зависимость: `tavily-python`
Инструмент использует официальную Python-библиотеку `tavily-python` для взаимодействия с API Tavily. Эта зависимость должна быть установлена в окружении, где запускается `mcp_server.py`.
```bash
pip install tavily-python
```

### 2.2. Управление API-ключами (Безопасность)
Модуль **не содержит API-ключ в открытом виде**. Вместо этого, при первом импорте он пытается прочитать ключ из переменной окружения `TAVILY_API_KEY`.

Задачу установки этой переменной окружения берет на себя `mcp_server.py`. При старте он читает ключ из файла `env/tavily.env` и помещает его в `os.environ`. Таким образом, `web_search.py` получает свой ключ безопасным и изолированным способом.

Если переменная окружения не найдена, клиент `tavily_client` не создается, а функция `search` будет возвращать ошибку, предотвращая падение всего сервиса.

### 2.3. Основная функция: `search()`
```python
def search(query: str, max_results: int = 5) -> dict:
    # ...
```
Это единственная публичная функция модуля.
*   **Параметры**:
    *   `query: str`: Текстовый поисковый запрос, который, как правило, генерируется LLM.
    *   `max_results: int` (по умолчанию 5): Контролирует количество возвращаемых результатов.
*   **Продвинутый поиск**: Функция явно использует опцию `search_depth="advanced"` в Tavily API. Это заставляет Tavily не просто искать, но и пытаться синтезировать и ранжировать наиболее релевантные результаты, что повышает качество данных, получаемых LLM.
*   **Формат ответа**: Функция всегда возвращает словарь для унифицированной обработки.
    *   **При успехе**: `{"result": [...]}`
    *   **При ошибке**: `{"error": "..."}`

## 3. Настройка и использование

### 3.1. Настройка API-ключа
1.  Создайте директорию `env/` в корне проекта (если ее нет).
2.  Внутри создайте файл `tavily.env`.
3.  Поместите в этот файл ваш API-ключ от сервиса Tavily.

### 3.2. Интеграция с `mcp_server.py`
Инструмент должен быть вызван через эндпоинт, определенный в `mcp_server.py`.

**Фрагмент из `mcp_server.py`:**
```python
# 1. Импорт функции
from tools.web_search import search as web_search_tool

# 2. Pydantic-модель для валидации запроса
class WebSearchRequest(BaseModel):
    query: str
    max_results: int = 5

# 3. FastAPI-эндпоинт
@app.post("/tools/web_search")
def run_web_search(request: WebSearchRequest):
    try:
        # 4. Вызов функции из этого модуля
        return web_search_tool(query=request.query, max_results=request.max_results)
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

### 3.3. Описание для LLM (`available_tools.py`)
Чтобы AI-агент мог использовать этот инструмент, он должен быть описан в файле `tools/available_tools.py`. Это описание служит "инструкцией" для модели. (См. документацию по `available_tools.py` для деталей).